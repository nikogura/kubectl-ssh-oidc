version: '3.8'

services:
  # Custom Dex with SSH connector
  dex:
    build:
      context: ../../
      dockerfile: docker/dex/Dockerfile
    image: kubectl-ssh-oidc/dex:latest
    ports:
      - "5556:5556"
    volumes:
      - ./dex-config.yaml:/etc/dex/cfg/config.template.yaml:ro
      - ./start-dex.sh:/start-dex.sh:ro
    environment:
      - TEST_KEY_FINGERPRINT_1=${TEST_KEY_FINGERPRINT_1:-SHA256:placeholder1}
      - TEST_KEY_FINGERPRINT_2=${TEST_KEY_FINGERPRINT_2:-SHA256:placeholder2}
      - TEST_KEY_FINGERPRINT_3=${TEST_KEY_FINGERPRINT_3:-SHA256:placeholder3}
    entrypoint: ["/bin/sh", "/start-dex.sh"]
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:5556/dex/.well-known/openid_configuration"]
      start_period: 10s
      interval: 10s
      timeout: 5s
      retries: 3
    networks:
      - integration-test

  # Mock Kubernetes API server for OIDC token validation
  mock-k8s-api:
    image: nginx:alpine
    ports:
      - "6443:80"
    volumes:
      - ./mock-k8s-config.json:/usr/share/nginx/html/api/v1/namespaces/default/pods:ro
    networks:
      - integration-test

networks:
  integration-test:
    driver: bridge