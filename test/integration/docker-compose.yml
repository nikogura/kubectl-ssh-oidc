version: '3.8'

services:
  # Custom Dex with SSH connector
  dex:
    build:
      context: ../../
      dockerfile: docker/dex/Dockerfile
    image: kubectl-ssh-oidc/dex:latest
    ports:
      - "5556:5556"
    volumes:
      - ./dex-config.yaml:/etc/dex/cfg/config.yaml:ro
    command: ["serve", "/etc/dex/cfg/config.yaml"]
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:5556/dex/.well-known/openid_configuration"]
      start_period: 10s
      interval: 10s
      timeout: 5s
      retries: 3
    networks:
      - integration-test

  # Mock Kubernetes API server for OIDC token validation
  mock-k8s-api:
    image: nginx:alpine
    ports:
      - "6443:80"
    volumes:
      - ./mock-k8s-config.json:/usr/share/nginx/html/api/v1/namespaces/default/pods:ro
    networks:
      - integration-test

networks:
  integration-test:
    driver: bridge